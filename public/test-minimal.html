<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Test</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin: 20px 0; }
        .panel { border: 1px solid #ccc; padding: 20px; border-radius: 8px; background: #f9f9f9; }
        .button { background: #007cba; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px 0; }
        .button:hover { background: #005a87; }
        .button:disabled { background: #ccc; cursor: not-allowed; }
        .debug { background: #ffeb3b; padding: 15px; margin: 10px 0; border-radius: 4px; }
        .item { border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 4px; cursor: pointer; }
        .item:hover { background: #e0e0e0; }
        .item.selected { background: #b3d9ff; border-color: #007cba; }
        .code { background: #333; color: #0f0; padding: 20px; border-radius: 4px; overflow-x: auto; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <h1>Minimal Vue Test - {{ preview.name }}</h1>
            
            <!-- Debug Info -->
            <div class="debug">
                <h3>Debug Info:</h3>
                <p>{{ debugInfo || 'No debug info yet' }}</p>
                <div style="margin-top: 10px; font-size: 14px;">
                    <p>Selected Category: {{ selectedCategory?.name || 'None' }}</p>
                    <p>Selected Feedback: {{ selectedFeedback?.name || 'None' }}</p>
                    <p>Selected Version: {{ selectedVersion?.name || 'None' }}</p>
                </div>
            </div>
            
            <div class="grid">
                <!-- Categories -->
                <div class="panel">
                    <h2>Categories</h2>
                    
                    <button class="button" @click="addCategory('banner')">
                        Add Banner Category
                    </button>
                    
                    <div>
                        <div 
                            v-for="category in preview.categories"
                            :key="category.tempId || category.id"
                            @click="selectCategory(category)"
                            :class="['item', selectedCategory?.tempId === category.tempId ? 'selected' : '']"
                        >
                            <div style="font-weight: bold;">{{ category.name }}</div>
                            <div style="font-size: 12px; color: #666;">{{ category.type }}</div>
                            <div style="font-size: 10px; color: #999;">
                                Feedbacks: {{ category.feedbacks?.length || 0 }}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Feedbacks -->
                <div class="panel">
                    <h2>Feedbacks</h2>
                    
                    <button 
                        class="button" 
                        @click="addFeedback"
                        :disabled="!selectedCategory"
                    >
                        Add Feedback
                    </button>
                    
                    <div v-if="selectedCategory?.feedbacks">
                        <div 
                            v-for="feedback in selectedCategory.feedbacks"
                            :key="feedback.tempId || feedback.id"
                            @click="selectFeedback(feedback)"
                            :class="['item', selectedFeedback?.tempId === feedback.tempId ? 'selected' : '']"
                        >
                            <div style="font-weight: bold;">{{ feedback.name }}</div>
                            <div style="font-size: 10px; color: #999;">
                                Sets: {{ feedback.feedback_sets?.length || 0 }}
                            </div>
                            
                            <!-- Feedback Sets -->
                            <div style="margin-top: 10px;">
                                <button 
                                    class="button" 
                                    style="font-size: 10px; padding: 5px 10px;"
                                    @click.stop="addFeedbackSet"
                                >
                                    Add Set
                                </button>
                                
                                <div v-if="feedback.feedback_sets" style="margin-left: 10px;">
                                    <div 
                                        v-for="feedbackSet in feedback.feedback_sets"
                                        :key="feedbackSet.tempId || feedbackSet.id"
                                        style="border: 1px solid #ddd; padding: 8px; margin: 5px 0; background: white;"
                                    >
                                        <div style="font-size: 12px; font-weight: bold;">{{ feedbackSet.name }}</div>
                                        <div style="font-size: 10px; color: #999;">
                                            Versions: {{ feedbackSet.versions?.length || 0 }}
                                        </div>
                                        
                                        <!-- Versions -->
                                        <div style="margin-top: 5px;">
                                            <button 
                                                style="font-size: 10px; padding: 3px 8px; background: #4CAF50; color: white; border: none; border-radius: 3px; cursor: pointer;"
                                                @click.stop="addVersion(feedbackSet)"
                                            >
                                                Add Version
                                            </button>
                                            
                                            <div v-if="feedbackSet.versions" style="margin-top: 5px;">
                                                <div 
                                                    v-for="version in feedbackSet.versions"
                                                    :key="version.tempId || version.id"
                                                    @click.stop="selectVersion(version)"
                                                    :style="{
                                                        padding: '3px 6px',
                                                        fontSize: '10px',
                                                        border: '1px solid #ccc',
                                                        borderRadius: '3px',
                                                        cursor: 'pointer',
                                                        margin: '2px 0',
                                                        background: selectedVersion?.tempId === version.tempId ? '#ffeb3b' : '#f5f5f5'
                                                    }"
                                                >
                                                    {{ version.name }} ({{ version.files?.length || 0 }} files)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Files -->
                <div class="panel">
                    <h2>Files</h2>
                    
                    <div v-if="selectedVersion">
                        <h3>{{ selectedVersion.name }}</h3>
                        
                        <label class="button" style="display: inline-block; text-align: center;">
                            Upload Files
                            <input 
                                type="file" 
                                multiple 
                                @change="onUploadFiles"
                                style="display: none;"
                            >
                        </label>
                        
                        <div v-if="selectedVersion.files && selectedVersion.files.length > 0" style="margin-top: 10px;">
                            <div 
                                v-for="file in selectedVersion.files"
                                :key="file.tempId || file.id"
                                class="item"
                            >
                                <div style="font-weight: bold; font-size: 12px;">{{ file.name }}</div>
                                <div style="font-size: 10px; color: #666;">Position: {{ file.position }}</div>
                            </div>
                        </div>
                        
                        <div v-else style="color: #999; font-style: italic; margin-top: 10px;">
                            No files uploaded yet
                        </div>
                    </div>
                    
                    <div v-else style="color: #999; font-style: italic;">
                        Select a version to manage files
                    </div>
                </div>
            </div>
            
            <!-- File Details -->
            <div v-if="getAllFiles().length > 0" style="background: #e3f2fd; padding: 20px; border-radius: 4px; margin: 20px 0;">
                <h3>üìÅ Actual Files (Proof they exist!):</h3>
                <div v-for="file in getAllFiles()" :key="file.tempId" style="margin: 10px 0; padding: 10px; background: white; border-radius: 4px;">
                    <strong>{{ file.name }}</strong><br>
                    <small>Size: {{ formatFileSize(file._zipFile.size) }} | Type: {{ file._zipFile.type }} | Last Modified: {{ formatDate(file._zipFile.lastModified) }}</small>
                </div>
            </div>
            
            <!-- Data Dump -->
            <div class="code">
                <h3 style="color: white; margin-top: 0;">Data Structure (Files show as {} due to JSON limitation):</h3>
                <pre>{{ JSON.stringify(preview, null, 2) }}</pre>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    preview: {
                        id: 6,
                        name: "Test Preview",
                        categories: []
                    },
                    selectedCategory: null,
                    selectedFeedback: null,
                    selectedVersion: null,
                    debugInfo: ''
                }
            },
            methods: {
                updateDebug(message) {
                    this.debugInfo = new Date().toLocaleTimeString() + ': ' + message;
                    console.log(this.debugInfo);
                },
                
                generateTempId() {
                    return `tmp-${Math.random().toString(36).slice(2, 9)}`;
                },
                
                addCategory(kind) {
                    this.updateDebug(`Adding category: ${kind}`);
                    
                    if (!this.preview.categories) this.preview.categories = [];
                    
                    const newCategory = {
                        tempId: this.generateTempId(),
                        preview_id: this.preview.id,
                        name: kind,
                        type: kind,
                        is_active: true,
                        feedbacks: [],
                        _state: 'created'
                    };
                    
                    this.preview.categories.push(newCategory);
                    this.selectedCategory = newCategory;
                    this.updateDebug(`Category added. Total categories: ${this.preview.categories.length}`);
                },
                
                selectCategory(category) {
                    this.selectedCategory = category;
                    this.selectedFeedback = null;
                    this.selectedVersion = null;
                    this.updateDebug(`Selected category: ${category.name}`);
                },
                
                addFeedback() {
                    if (!this.selectedCategory) {
                        this.updateDebug('No category selected');
                        return;
                    }
                    
                    this.updateDebug(`Adding feedback to category: ${this.selectedCategory.name}`);
                    
                    if (!this.selectedCategory.feedbacks) {
                        this.selectedCategory.feedbacks = [];
                    }
                    
                    const newFeedback = {
                        tempId: this.generateTempId(),
                        category_id: this.selectedCategory.id || this.selectedCategory.tempId,
                        name: `Feedback ${this.selectedCategory.feedbacks.length + 1}`,
                        is_active: true,
                        feedback_sets: [],
                        _state: 'created'
                    };
                    
                    this.selectedCategory.feedbacks.push(newFeedback);
                    this.selectedFeedback = newFeedback;
                    this.updateDebug(`Feedback added. Total feedbacks: ${this.selectedCategory.feedbacks.length}`);
                },
                
                selectFeedback(feedback) {
                    this.selectedFeedback = feedback;
                    this.selectedVersion = null;
                    this.updateDebug(`Selected feedback: ${feedback.name}`);
                },
                
                addFeedbackSet() {
                    if (!this.selectedFeedback) {
                        this.updateDebug('No feedback selected');
                        return;
                    }
                    
                    this.updateDebug(`Adding feedback set to: ${this.selectedFeedback.name}`);
                    
                    if (!this.selectedFeedback.feedback_sets) {
                        this.selectedFeedback.feedback_sets = [];
                    }
                    
                    const newSet = {
                        tempId: this.generateTempId(),
                        feedback_id: this.selectedFeedback.id || this.selectedFeedback.tempId,
                        name: `Set ${this.selectedFeedback.feedback_sets.length + 1}`,
                        versions: [],
                        _state: 'created'
                    };
                    
                    this.selectedFeedback.feedback_sets.push(newSet);
                    this.updateDebug(`Feedback set added. Total sets: ${this.selectedFeedback.feedback_sets.length}`);
                },
                
                addVersion(feedbackSet) {
                    this.updateDebug(`Adding version to set: ${feedbackSet.name}`);
                    
                    if (!feedbackSet.versions) {
                        feedbackSet.versions = [];
                    }
                    
                    const newVersion = {
                        tempId: this.generateTempId(),
                        feedback_set_id: feedbackSet.id || feedbackSet.tempId,
                        name: `Version ${feedbackSet.versions.length + 1}`,
                        files: [],
                        _state: 'created'
                    };
                    
                    feedbackSet.versions.push(newVersion);
                    this.selectedVersion = newVersion;
                    this.updateDebug(`Version added. Total versions: ${feedbackSet.versions.length}. Selected: ${newVersion.name}`);
                },
                
                selectVersion(version) {
                    this.selectedVersion = version;
                    this.updateDebug(`Selected version: ${version.name}`);
                },
                
                onUploadFiles(event) {
                    if (!this.selectedVersion) {
                        this.updateDebug('No version selected for file upload');
                        return;
                    }
                    
                    const files = event.target.files;
                    
                    if (!files?.length) {
                        this.updateDebug('No files selected');
                        return;
                    }
                    
                    this.updateDebug(`Uploading ${files.length} files to version: ${this.selectedVersion.name}`);
                    
                    if (!this.selectedVersion.files) {
                        this.selectedVersion.files = [];
                    }
                    
                    let position = this.selectedVersion.files.length;
                    
                    Array.from(files).forEach(file => {
                        const newFile = {
                            tempId: this.generateTempId(),
                            version_id: this.selectedVersion.id || this.selectedVersion.tempId,
                            name: file.name,
                            position: position++,
                            _zipFile: file,
                            _state: 'created'
                        };
                        
                        this.selectedVersion.files.push(newFile);
                    });
                    
                    event.target.value = '';
                    this.updateDebug(`Files added. Total files in version: ${this.selectedVersion.files.length}`);
                },
                
                getAllFiles() {
                    const files = [];
                    this.preview.categories?.forEach(category => {
                        category.feedbacks?.forEach(feedback => {
                            feedback.feedback_sets?.forEach(feedbackSet => {
                                feedbackSet.versions?.forEach(version => {
                                    version.files?.forEach(file => {
                                        if (file._zipFile) {
                                            files.push(file);
                                        }
                                    });
                                });
                            });
                        });
                    });
                    return files;
                },
                
                formatFileSize(bytes) {
                    if (!bytes) return 'Unknown size';
                    if (bytes < 1024) return bytes + ' bytes';
                    if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
                    return (bytes / 1048576).toFixed(2) + ' MB';
                },
                
                formatDate(timestamp) {
                    if (!timestamp) return 'Unknown date';
                    return new Date(timestamp).toLocaleString();
                }
            },
            
            mounted() {
                this.updateDebug('Component loaded successfully');
                console.log('Vue app mounted!', this.preview);
            }
        }).mount('#app');
    </script>
</body>
</html>
